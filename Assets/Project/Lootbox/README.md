# Лутбокс (Мини-слот) — Инструкция по настройке

## Структура проекта

| Файл | Назначение |
|------|------------|
| `Scripts/LootboxApp.cs` | Точка входа приложения. Инициализирует модель, регистрирует FSM-состояния, запускает машину состояний. |
| `Scripts/FSM/LootboxStates.cs` | Все FSM-состояния: Idle, Spinning, Stopping, ShowResult. |
| `Scripts/UI/UIButtonDataBind.cs` | Универсальный компонент привязки кнопки к FSM через `Settings.Invoke` и `Model`. |
| `Scripts/Slot/SlotReelController.cs` | Контроллер барабана. Управляет движением элементов, скоростью прокрутки, остановкой на целевом результате. |
| `Scripts/Effects/ResultParticleController.cs` | Контроллер частиц. Запускает систему частиц при отображении результата (событие `PlayResultParticles`). |

---

## Настройка сцены в Unity

### 1. Canvas

1. Создайте **Canvas** (`GameObject → UI → Canvas`).
2. На компоненте **Canvas Scaler** установите:
   - **UI Scale Mode**: `Scale With Screen Size`
   - **Reference Resolution**: `1920 × 1080`
   - **Screen Match Mode**: `Match Width Or Height`
   - **Match**: `0.5`
3. Убедитесь, что Canvas использует **Render Mode**: `Screen Space – Overlay`.

### 2. LootboxApp

1. Создайте пустой `GameObject` и назовите его **LootboxApp**.
2. Прикрепите к нему компонент `LootboxApp.cs`.
3. Этот объект является точкой входа — он инициализирует `Settings.Model`, создаёт и запускает FSM.

### 3. Контейнер барабана (ReelContainer)

1. Внутри Canvas создайте **Panel** и назовите её **ReelContainer**.
2. Настройте **RectTransform**:
   - **Width**: `220`
   - **Height**: `600` (3 видимых элемента × 200 px)
   - **Anchors**: центр экрана (Middle-Center)
   - **Pivot**: `(0.5, 0.5)`
3. Добавьте компонент **Rect Mask 2D** — он будет обрезать элементы, выходящие за границы контейнера при прокрутке.
4. При необходимости уберите компонент **Image** с панели (или сделайте его прозрачным), чтобы фон не перекрывал элементы.

### 4. Элементы слота (Slot Items)

1. Внутри **ReelContainer** создайте **5** дочерних `Image` (`GameObject → UI → Image`).
2. Назовите их: `SlotItem_0`, `SlotItem_1`, `SlotItem_2`, `SlotItem_3`, `SlotItem_4`.
3. Для каждого элемента:
   - **RectTransform Size**: `200 × 200`
   - **Anchors**: Middle-Center
4. Начальное расположение будет задано автоматически контроллером `SlotReelController`.

### 5. SlotReelController

1. Прикрепите компонент `SlotReelController.cs` к объекту **ReelContainer**.
2. В инспекторе настройте поля:
   - **_container**: перетащите сюда **ReelContainer** (RectTransform).
   - **_itemHeight**: `200`
   - **_maxSpeed**: `2000`
   - **_sprites**: перетащите спрайт-ассеты (иконки предметов лутбокса) в массив.
3. Контроллер автоматически расставит дочерние элементы по вертикали и будет управлять их позициями при прокрутке.

### 6. Кнопки управления

1. Создайте две **UI Button** (`GameObject → UI → Button`):
   - **BtnStart** — запуск барабана
   - **BtnStop** — остановка барабана
2. К каждой кнопке прикрепите компонент **UIButtonDataBind**.
3. Настройте параметры:

   | Кнопка | `_eventName` | `_enabledFieldName` |
   |--------|-------------|---------------------|
   | BtnStart | `BtnStart` | `BtnStartEnabled` |
   | BtnStop | `BtnStop` | `BtnStopEnabled` |

4. Расположите кнопки в нижней части экрана. Рекомендуется использовать **Horizontal Layout Group** на родительском контейнере для автоматического выравнивания.

### 7. Система частиц (Particle System)

1. Создайте **Particle System** как дочерний объект **ReelContainer** (или рядом с ним).
2. Настройте параметры:
   - **Duration**: `1.5`
   - **Play On Awake**: **выключено** ✗
   - **Emission → Bursts**: `1` burst, Count = `30`
   - **Shape**: `Cone`
   - **Start Color**: золотой/жёлтый оттенок
   - **Size over Lifetime**: убывание (кривая от 1 к 0)
   - **Start Lifetime**: `1.0–1.5`
3. Прикрепите компонент `ResultParticleController.cs` к этому же объекту (или к родителю).
4. В инспекторе перетащите объект Particle System в поле **_particleSystem**.
   - Если поле оставить пустым, компонент автоматически найдёт `ParticleSystem` среди дочерних объектов при инициализации.

### 8. Тестирование разрешений

Проверьте корректность отображения на следующих разрешениях:

| Разрешение | Соотношение сторон |
|------------|-------------------|
| 1920 × 1080 | 16:9 |
| 1600 × 900 | 16:9 |
| 2560 × 1440 | 16:9 |
| 1366 × 768 | ≈16:9 |

**Что проверять:**
- Canvas масштабируется корректно при изменении размера окна.
- Элементы барабана остаются в центре экрана.
- Маска Rect Mask 2D корректно обрезает элементы за границами контейнера.
- Кнопки не перекрывают область барабана.

---

## FSM-состояния

Машина состояний управляет жизненным циклом мини-слота. Переходы между состояниями:

```
Idle → Spinning → Stopping → ShowResult → Idle
```

| Состояние | Описание |
|-----------|----------|
| **Idle** | Начальное состояние. Кнопка «Старт» активна, кнопка «Стоп» неактивна. Барабан неподвижен. |
| **Spinning** | Барабан вращается с нарастающей скоростью до `_maxSpeed`. Обе кнопки неактивны первые 3 секунды, затем кнопка «Стоп» активируется (`[One(3.0f)]`). |
| **Stopping** | Барабан плавно замедляется и останавливается на целевом элементе. Обе кнопки неактивны. |
| **ShowResult** | Отображение результата. Вызывается событие `PlayResultParticles` для воспроизведения частиц. Кнопка «Старт» активна — по нажатию переход в `Spinning`. |

---

## Сигналы и события

### Пользовательские события (кнопки → FSM)

| Событие | Источник | Описание |
|---------|----------|----------|
| `BtnStart` | UIButtonDataBind | Нажатие кнопки «Старт». FSM обрабатывает в состоянии Idle и переходит в Spinning. |
| `BtnStop` | UIButtonDataBind | Нажатие кнопки «Стоп». FSM обрабатывает в состоянии Spinning и переходит в Stopping. |

### Внутренние события (FSM → компоненты)

| Событие | Источник | Получатель | Описание |
|---------|----------|------------|----------|
| `OnSlotStateChanged` | FSM | SlotReelController | Уведомление об изменении состояния барабана (Idle, Spinning, Stopping). |
| `OnSlotStopped` | SlotReelController | FSM | Барабан завершил остановку и зафиксировался на результате. |
| `PlayResultParticles` | FSM (ShowResult) | ResultParticleController | Запуск системы частиц для визуального эффекта результата. |

### Поля модели (Model → UI)

| Поле | Тип | Описание |
|------|-----|----------|
| `BtnStartEnabled` | `bool` | Управляет доступностью кнопки «Старт». |
| `BtnStopEnabled` | `bool` | Управляет доступностью кнопки «Стоп». |

Поля устанавливаются через `Model.Set("BtnStartEnabled", true/false)` в обработчиках входа в состояния FSM. Компонент `UIButtonDataBind` автоматически подписывается на изменения этих полей и включает/выключает кнопку.
